<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/static/image/logo.jpeg">
    <title>Alertes</title>
    <link rel="icon" type="image/png" href="/static/image/logo.jpeg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#EB5B00'
                    }
                }
            }
        }
    </script>
</head>
<body >

    <div id="menu"></div>

    <div class="max-w-3xl mx-auto bg-white shadow-md rounded-lg overflow-hidden">
      <div class="text-primary text-center py-6">
        <h2 class="text-2xl font-semibold flex items-center justify-center gap-2">
            <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" stroke-width="2"
                viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M15 17h5l-1.405-1.405C18.21 15.21 18 14.703 18 14.172V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.172c0 .531-.21 1.038-.595 1.423L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                </path>
            </svg>
            Alertes Système
        </h2>
    </div>
    
        <div id="alerts-container" class="p-6 space-y-4">
            <p class="text-gray-500">Chargement des alertes...</p>
        </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
  const menuDiv = document.getElementById("menu");

  fetch("/static/menu.html")
    .then(response => response.text())
    .then(data => {
      if (menuDiv) {
        menuDiv.innerHTML = data;
        // Maintenant que le menu est chargé, nous pouvons attacher les événements et vérifier l'état actif pour les deux menus.
        attachEventListenersToNav('.desktop-nav');
        attachEventListenersToNav('.mobile-nav');
        checkAndApplyActiveStateOnLoad();
      }
    })
    .catch(error => {
      console.error('Erreur lors du chargement du menu :', error);
    });

  function attachEventListenersToNav(navSelector) {
    const nav = document.querySelector(navSelector);
    if (nav) {
      const navItems = nav.querySelectorAll('.nav-item, .mobile-nav-item');
      navItems.forEach(item => {
        item.addEventListener('click', function(event) {
          activateNavItem(this, navSelector);
          // La navigation vers la nouvelle page se fera normalement grâce au lien <a>
        });
      });
    }
  }

  function activateNavItem(item, navSelector) {
    const activeItem = document.querySelector(`${navSelector} .nav-item.active, ${navSelector} .mobile-nav-item.active`);
    if (activeItem && activeItem !== item) {
      activeItem.classList.remove('active');
    }
    item.classList.add('active');
    localStorage.setItem('activeNavLink', item.dataset.navlink);
  }

  function checkAndApplyActiveStateOnLoad() {
    const storedActiveNavLink = localStorage.getItem('activeNavLink');
    const desktopNavItems = document.querySelectorAll('.desktop-nav .nav-item');
    const mobileNavItems = document.querySelectorAll('.mobile-nav .mobile-nav-item');
    const currentPage = window.location.pathname;

    const allNavItems = [...desktopNavItems, ...mobileNavItems]; // Combine les deux listes

    if (storedActiveNavLink) {
      allNavItems.forEach(item => {
        if (item.dataset.navlink === storedActiveNavLink) {
          item.classList.add('active');
        }
      });
    } else {
      // Logique pour activer un élément par défaut au chargement initial (si nécessaire)
      if (currentPage === '/' || currentPage === '/dashboard') {
        allNavItems.forEach(item => {
          if (item.dataset.navlink === 'accueil') {
            item.classList.add('active');
            localStorage.setItem('activeNavLink', 'accueil');
          }
        });
      } else {
        allNavItems.forEach(item => {
          if (item.getAttribute('href') === currentPage) {
            item.classList.add('active');
            localStorage.setItem('activeNavLink', item.dataset.navlink);
          }
        });
      }
    }
  }
});
        const alertsContainer = document.getElementById("alerts-container");

        async function fetchAndDisplayAlerts() {
            try {
                const response = await fetch("/api/alerts");
                if (!response.ok) {
                    console.error("Erreur lors de la récupération des alertes:", response.status);
                    alertsContainer.innerHTML = "<p class='text-red-500'>Erreur lors du chargement des alertes.</p>";
                    return;
                }
                const alerts = await response.json();
                displayAlerts(alerts);
            } catch (error) {
                console.error("Erreur réseau lors de la récupération des alertes:", error);
                alertsContainer.innerHTML = "<p class='text-red-500'>Erreur réseau lors du chargement des alertes.</p>";
            }
        }

        function displayAlerts(alerts) {
            if (alertsContainer) {
                alertsContainer.innerHTML = "";
                if (alerts.length === 0) {
                    alertsContainer.innerHTML = "<p class='text-gray-500'>Aucune alerte pour le moment.</p>";
                    return;
                }
                alerts.forEach(alert => {
                    const alertDiv = document.createElement("div");
                    alertDiv.className = "flex items-start gap-4 bg-red-50 border-l-4 border-red-500 text-red-700 px-4 py-4 rounded-md shadow-sm";
                    alertDiv.innerHTML = `
                        <div class="pt-1">
                            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" stroke-width="2"
                                viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.054 0 1.635-1.14 1.054-2.053L13.054 4.947c-.526-.81-1.582-.81-2.108 0L3.028 16.947C2.447 17.86 3.028 19 4.082 19z">
                                </path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <p><strong class="font-bold">Alerte :</strong> ${alert.site_name} (${alert.url_or_ip}) est hors ligne.</p>
                            <p><strong>Raison :</strong> ${alert.reason}</p>
                            <p class="text-sm text-gray-600"><strong>Date :</strong> ${new Date(alert.timestamp).toLocaleString()}</p>
                        </div>
                       
                    `;
                    alertsContainer.appendChild(alertDiv);
                });
            }
        }

      

        fetchAndDisplayAlerts();
        setInterval(fetchAndDisplayAlerts, 10000);
    </script>

</body>
</html>
