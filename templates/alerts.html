<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/static/image/logo.jpeg">
    <title>Alertes</title>
   
    
    <link href="https://cdn.jsdelivr.net/npm/lucide-icons@0.1.0/dist/lucide.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
       h2  , i ,.pa{
      color: #205781;
    }
    </style>
</head>
<body >

    <div id="menu"></div>

    <div class="max-w-3xl mx-auto  overflow-hidden">
      <div class="text-primary text-center py-6">
        <h2 class="text-2xl font-semibold flex items-center justify-center gap-2">
          <i data-lucide="alert-triangle" class="w-6 h-6 text-primary"></i>
          Alertes Système
        </h2>
        
        
      
        <div class="flex justify-end mb-4">
          <button onclick="deleteAllAlerts()"
              class="flex items-center gap-2 px-4 py-2 bg-red-700 text-white rounded hover:bg-red-800">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2"
                  viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m2 0a2 2 0 00-2-2H9a2 2 0 00-2 2m10 0H5">
                  </path>
              </svg>
              Supprimer toutes les alertes
          </button>
        </div>
        
        <script src="https://unpkg.com/lucide@latest"></script>
        <script>
          lucide.createIcons();
        </script>
        
        <div id="alerts-container" class="p-6 space-y-4">
            <p class="text-gray-500">Chargement des alertes...</p>
        </div>
    </div>
   
  
    <script>
      document.addEventListener('DOMContentLoaded', () => {
  const menuDiv = document.getElementById("menu");

  fetch("/static/menu.html")
    .then(response => response.text())
    .then(data => {
      if (menuDiv) {
        menuDiv.innerHTML = data;
        // Maintenant que le menu est chargé, nous pouvons attacher les événements et vérifier l'état actif pour les deux menus.
        attachEventListenersToNav('.desktop-nav');
        attachEventListenersToNav('.mobile-nav');
        checkAndApplyActiveStateOnLoad();
      }
    })
    .catch(error => {
      console.error('Erreur lors du chargement du menu :', error);
    });

  function attachEventListenersToNav(navSelector) {
    const nav = document.querySelector(navSelector);
    if (nav) {
      const navItems = nav.querySelectorAll('.nav-item, .mobile-nav-item');
      navItems.forEach(item => {
        item.addEventListener('click', function(event) {
          activateNavItem(this, navSelector);
          // La navigation vers la nouvelle page se fera normalement grâce au lien <a>
        });
      });
    }
  }

  function activateNavItem(item, navSelector) {
    const activeItem = document.querySelector(`${navSelector} .nav-item.active, ${navSelector} .mobile-nav-item.active`);
    if (activeItem && activeItem !== item) {
      activeItem.classList.remove('active');
    }
    item.classList.add('active');
    localStorage.setItem('activeNavLink', item.dataset.navlink);
  }

  function checkAndApplyActiveStateOnLoad() {
    const storedActiveNavLink = localStorage.getItem('activeNavLink');
    const desktopNavItems = document.querySelectorAll('.desktop-nav .nav-item');
    const mobileNavItems = document.querySelectorAll('.mobile-nav .mobile-nav-item');
    const currentPage = window.location.pathname;

    const allNavItems = [...desktopNavItems, ...mobileNavItems]; // Combine les deux listes

    if (storedActiveNavLink) {
      allNavItems.forEach(item => {
        if (item.dataset.navlink === storedActiveNavLink) {
          item.classList.add('active');
        }
      });
    } else {
      // Logique pour activer un élément par défaut au chargement initial (si nécessaire)
      if (currentPage === '/' || currentPage === '/dashboard') {
        allNavItems.forEach(item => {
          if (item.dataset.navlink === 'accueil') {
            item.classList.add('active');
            localStorage.setItem('activeNavLink', 'accueil');
          }
        });
      } else {
        allNavItems.forEach(item => {
          if (item.getAttribute('href') === currentPage) {
            item.classList.add('active');
            localStorage.setItem('activeNavLink', item.dataset.navlink);
          }
        });
      }
    }
  }
});
        const alertsContainer = document.getElementById("alerts-container");

        async function fetchAndDisplayAlerts() {
            try {
                const response = await fetch("/api/alerts");
                if (!response.ok) {
                    console.error("Erreur lors de la récupération des alertes:", response.status);
                    alertsContainer.innerHTML = "<p class='text-red-500'>Erreur lors du chargement des alertes.</p>";
                    return;
                }
                const alerts = await response.json();
                displayAlerts(alerts);
            } catch (error) {
                console.error("Erreur réseau lors de la récupération des alertes:", error);
                alertsContainer.innerHTML = "<p class='text-red-500'>Erreur réseau lors du chargement des alertes.</p>";
            }
        }

        function displayAlerts(alerts) {
    if (alertsContainer) {
        alertsContainer.innerHTML = "";
        if (alerts.length === 0) {
            alertsContainer.innerHTML = "<p class='text-gray-500'>Aucune alerte pour le moment.</p>";
            return;
        }
        alerts.forEach(alert => {
            const alertDiv = document.createElement("div");
            alertDiv.className = "flex items-start gap-4 bg-red-50 border-l-4 border-red-500 text-red-700 px-4 py-4 rounded-md shadow-sm justify-between";

            alertDiv.innerHTML = `
            

    <div class="pt-1">
     

        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" stroke-width="2"
            viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.054 0 1.635-1.14 1.054-2.053L13.054 4.947c-.526-.81-1.582-.81-2.108 0L3.028 16.947C2.447 17.86 3.028 19 4.082 19z">
            </path>
        </svg>
    </div>
    <div class="flex-1">
        <p><strong class="font-bold">Alerte :</strong> ${alert.site_name} (${alert.url_or_ip}) est hors ligne.</p>
        <p><strong>Raison :</strong> ${alert.reason}</p>
        <p class="text-sm text-gray-600"><strong>Date :</strong> ${new Date(alert.timestamp).toLocaleString()}</p>
    </div>
    <button onclick="deleteAlert(${alert.id})"
        class="ml-4 px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
        Supprimer
    </button>
`;

            alertsContainer.appendChild(alertDiv);
        });
    }
}

      
async function deleteAllAlerts() {
    if (!confirm("Êtes-vous sûr de vouloir supprimer toutes les alertes ?")) return;

    try {
        const response = await fetch("/api/alerts", {
            method: "DELETE"
        });

        if (!response.ok) {
            throw new Error(`Erreur HTTP ${response.status}`);
        }

        // Recharger les alertes
        fetchAndDisplayAlerts();
    } catch (error) {
        console.error("Erreur lors de la suppression de toutes les alertes :", error);
        alertsContainer.innerHTML = `<p class='text-red-500'>Erreur lors de la suppression de toutes les alertes.</p>`;
    }
}

async function deleteAlert(id) {
    if (!confirm("Voulez-vous vraiment supprimer cette alerte ?")) return;
    try {
        const response = await fetch(`/api/alerts/${id}`, {
            method: "DELETE",
        });

        if (!response.ok) {
            throw new Error(`Erreur HTTP ${response.status}`);
        }

        // Recharger les alertes après suppression
        fetchAndDisplayAlerts();
    } catch (error) {
        console.error("Erreur lors de la suppression de l'alerte:", error);
        alertsContainer.innerHTML = `<p class='text-red-500'>Erreur lors de la suppression de l'alerte.</p>`;
    }
}


        fetchAndDisplayAlerts();
        setInterval(fetchAndDisplayAlerts, 10000);
    </script>

</body>
</html>
